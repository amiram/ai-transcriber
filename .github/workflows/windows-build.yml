name: Windows Build and Release

on:
  push:
    branches: [ main ]
    tags: ['*']
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install build dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pyinstaller==5.11.0

      - name: Build executable with PyInstaller
        run: |
          .\scripts\build_windows.ps1 -PythonExe python
        shell: pwsh

      - name: Show dist/ contents for debugging
        run: |
          dir .\dist\ /s
        shell: cmd

      - name: Upload PyInstaller log and build folder (diagnostics)
        uses: actions/upload-artifact@v4
        with:
          name: pyinstaller-diagnostics
          path: |
            pyinstaller_build.log
            build/**
            dist/**

      - name: Package portable ZIP
        run: |
          pwsh .\scripts\package_portable.ps1 -ExeName "Transcriber.exe" -DistDir "dist" -OutZip "Transcriber_portable.zip"
        shell: pwsh

      - name: Compile Inno Setup installer
        run: |
          "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" "installer\\transcriber.iss"
        shell: cmd

      - name: Collect installer executable into a stable path
        run: |
          echo "Looking for any .exe files under installer\Output and copying the newest one to ./TranscriberSetup.exe"
          powershell -NoProfile -Command "\
            $out = Get-ChildItem -Path 'installer\Output' -Filter '*.exe' -File -Recurse -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1; \
            if ($null -ne $out) { Copy-Item -Path $out.FullName -Destination (Join-Path (Get-Location) 'TranscriberSetup.exe') -Force; Write-Host \"Copied installer: $($out.FullName) -> TranscriberSetup.exe\" } else { Write-Host 'No installer executable found under installer\Output'; exit 0 }"
        shell: pwsh

      - name: Verify expected artifacts exist (dist & installer)
        run: |
          echo "Checking for dist\Transcriber.exe"
          if exist dist\Transcriber.exe (echo "FOUND dist\Transcriber.exe") else echo "MISSING dist\Transcriber.exe"
          echo "Checking for installer TranscriberSetup.exe in repo root"
          if exist TranscriberSetup.exe (echo "FOUND TranscriberSetup.exe") else echo "MISSING TranscriberSetup.exe"
        shell: cmd

      - name: Create GitHub Release
        id: create_release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist\Transcriber.exe
            Transcriber_portable.zip
            TranscriberSetup.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}

      - name: Upload release assets (fallback)
        if: steps.create_release.outcome != 'success'
        uses: actions/upload-artifact@v4
        with:
          name: transcriber-artifacts
          path: |
            dist\Transcriber.exe
            Transcriber_portable.zip
            TranscriberSetup.exe
